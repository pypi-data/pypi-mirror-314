#Build python source distribution package and pushes it to gcloud artifactory
name: "App-Release-Publish"

on:
  workflow_call:
    inputs:
      repoName:
        default: ''
        required: false
        type: string
      version:
        default: '0.0.0'
        required: true 
        type: string
      branch:
         default: 'main'
         required: true
         type: string
      python_version:
        default: '3.9'
        required: true
        type: string
      skip_tests:
        default: false
        required: false
        type: boolean 
      package_type:
        default: ''
        required: true
        type: string
    secrets:
      PROVIDER_NAME:
        required: true
      SA_EMAIL:
         required: true
      GCP_ARTIFACTORY_URL:
         required: true
      GCP_ARTIFACTORY_USERNAME:
         required: true
      HDO_GITHUB_APP_PEM:
        required: true
      HDO_GITHUB_APP_ID:
        required: true

jobs:
  create-tag:
    name: "Create Release Tag"
    runs-on: ubuntu-latest
    steps:
      - name: Validate version
        id: validate_version
        run: |
          if [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "Input version is valid"
          else
            echo "Version is not valid.Provide correct semantic version"
            exit 1
          fi

      - name: Validate branch
        id: validate_branch
        run: |
          if [[ "${{ inputs.branch }}" == 'main' ]]; then
            echo "Branch is valid for tag creation."
          else
            echo "Branch is not valid. Tag can only be created in the main branch."
            exit 1
          fi
      - name: Get Token for workflow
        id: get_workflow_token
        uses: peter-murray/workflow-application-token-action@v3.0.0
        with:
          application_private_key: ${{ secrets.HDO_GITHUB_APP_PEM }}
          application_id: ${{ secrets.HDO_GITHUB_APP_ID }}
      - name: Checkout Repo
        uses: actions/checkout@v4.1.5
        with:
          token: ${{steps.get_workflow_token.outputs.token}}
          repository: ${{ inputs.repoName }}
          ref: ${{ inputs.branch }}
      - uses: rickstaa/action-create-tag@v1
        id: "tag_create"
        with:
          tag: "${{ inputs.version }}"
          tag_exists_error: true
          message: "Latest ${{ inputs.version }}"    
                            
  build-publish-sdist:
     if: ${{ inputs.package_type == 'source-distribution' }}
     uses: telus-health/thdp-hds-cloud-functions/.github/workflows/source-distribution-package.yaml@Ah-cloud-function
     needs: create-tag
     with:
      version: ${{ inputs.version }}
      branchName: ${{ inputs.branch }}
      repoName: ${{ inputs.repoName }}
      python_version: ${{ inputs.python_version }}
      skip_tests: ${{ inputs.skip_tests }}
     secrets:
       SA_EMAIL: ${{ secrets.SA_EMAIL }}
       PROVIDER_NAME: ${{ secrets.PROVIDER_NAME }}
       GCP_ARTIFACTORY_USERNAME: ${{ secrets.GCP_ARTIFACTORY_USERNAME }}
       GCP_ARTIFACTORY_URL: ${{ secrets.GCP_ARTIFACTORY_URL }} 
      #  GCP_ARTIFACTORY_URL: "//artifactregistry.googleapis.com/projects/thdp-hds-shrd-artifacts-25d4/locations/northamerica-northeast1/repositories/northamerica-northeast1-docker.pkg.dev/thdp-hds-shrd-artifacts-25d4/th-hds-shared-artifactory"

       HDO_GITHUB_APP_PEM: ${{ secrets.HDO_GITHUB_APP_PEM }}
       HDO_GITHUB_APP_ID: ${{ secrets.HDO_GITHUB_APP_ID }}

  build-publish-wheel:
     if: ${{ inputs.package_type == 'wheel' }}
     uses: telus-health/thdp-hds-cloud-functions/.github/workflows/wheel-package.yaml@Ah-cloud-function
     needs: create-tag
     with:
      version: ${{ inputs.version}}
      branchName: ${{ inputs.branch }}
      repoName: ${{ inputs.repoName }}
      skip_tests: ${{ inputs.skip_tests }}
      python_version: ${{ inputs.python_version }}
     secrets:
       SA_EMAIL: ${{ secrets.SA_EMAIL }}
       PROVIDER_NAME: ${{ secrets.PROVIDER_NAME }}
       GCP_ARTIFACTORY_USERNAME: ${{ secrets.GCP_ARTIFACTORY_USERNAME }}
       GCP_ARTIFACTORY_URL: ${{ secrets.GCP_ARTIFACTORY_URL }}
      #  GCP_ARTIFACTORY_URL: "//artifactregistry.googleapis.com/projects/thdp-hds-shrd-artifacts-25d4/locations/northamerica-northeast1/repositories/northamerica-northeast1-docker.pkg.dev/thdp-hds-shrd-artifacts-25d4/th-hds-shared-artifactory"

       HDO_GITHUB_APP_PEM: ${{ secrets.HDO_GITHUB_APP_PEM }}
       HDO_GITHUB_APP_ID: ${{ secrets.HDO_GITHUB_APP_ID }}
       
  rollback-tag:
    name: "Rollback Tag"
    if: ${{ failure() && needs.create-tag.result == 'success' }}
    needs:
      - create-tag
      - build-publish-wheel
      - build-publish-sdist
    runs-on: ubuntu-latest  
    steps:
      - name: Get Token for workflow
        id: get_workflow_token
        uses: peter-murray/workflow-application-token-action@v3.0.0
        with:
          application_private_key: ${{ secrets.HDO_GITHUB_APP_PEM }}
          application_id: ${{ secrets.HDO_GITHUB_APP_ID }}
      - name: Checkout Repo
        uses: actions/checkout@v4.1.5
        with:
          token: ${{steps.get_workflow_token.outputs.token}}
          repository: ${{ inputs.repoName }}
          ref: ${{ inputs.branch }}

      - name: Delete tag
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: ${{ inputs.version }} 
        env:
          GITHUB_TOKEN: ${{steps.get_workflow_token.outputs.token}}



 
  