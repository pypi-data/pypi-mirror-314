import{p as M,q as R,s as O,o as d,e as g,z as e,f as n,k as U,F as A,A as W,V as K,g as x,h as P,b as V,N as Z}from"./vue-DqMao7g8.js";import{u as E,b as q,c as H,a as I}from"./vue-router-CCNp7My1.js";import{C as $}from"./bootstrap.esm-BOBBXxos.js";import{_ as j}from"./lodash-uc_7-CSk.js";import{_ as J}from"./DateRangePicker-CmtuJeio.js";import{$ as c}from"./jquery-BALIvAru.js";import{m as T}from"./moment-CMyQs7Vz.js";import"./highlight.js-CWp04Ajj.js";import"./daterangepicker-i3LpM03M.js";const Q={__name:"MonitoringChart",props:["graph","metrics","from","to"],emits:["onZoom"],setup(N,{emit:C}){const u=N,_=M(null);let m;const L=C;R(()=>""+u.from+u.to,t),O(t);function t(r){const o=u.graph,b=u.from,p=u.to,y={axisLabelFontSize:10,yLabelWidth:14,legend:"always",labelsDiv:"legend"+o,labelsKMB:!0,animatedZooms:!0,gridLineColor:"#DDDDDD",dateWindow:[new Date(b).getTime(),new Date(p).getTime()],xValueParser:function(l){return T(l).toDate().getTime()},drawCallback:function(l,s){B(o,l,s),l.numRows()===0?c("#nodata"+o).removeClass("d-none"):c("#nodata"+o).addClass("d-none")},zoomCallback:z,interactionModel:{mousedown:function(l,s,a){a.initializeMouseDown(l,s,a),l.shiftKey?Dygraph.startPan(l,s,a):Dygraph.startZoom(l,s,a)},mousemove:function(l,s,a){a.isPanning?Dygraph.movePan(l,s,a):a.isZooming&&Dygraph.moveZoom(l,s,a)},mouseup:function(l,s,a){if(a.isPanning){Dygraph.endPan(l,s,a);const i=s.dateWindow_;z(i[0],i[1])}else a.isZooming&&Dygraph.endZoom(l,s,a)}}};for(var v in u.metrics[o].options)y[v]=u.metrics[o].options[v];const S="?start="+f(b)+"&end="+f(p)+"&noerror=1";let k=null;const D=c.get(apiUrl+"/"+u.metrics[o].api+S,function(l){k=l});let w="",F=c.when(D);u.metrics[o].category=="postgres"&&(F=c.when(D,c.get(unavailabilityUrl+S,function(l){w=l}))),F.then(function(){const l=k.split(`
`)[0].split(",").length,s=new Array(l-1).fill("NaN");s.unshift(""),w=w.replace(/\n/g,s.join(",")+`
`),!m||r?m=new Dygraph(_.value,k+w,y):m.ready(function(){m.updateOptions({dateWindow:[b,p]}),m.updateOptions({file:k+w},!1)})})}function f(r){return new Date(r).toISOString()}function B(r,o,b){if(!b)return;let p=0,y="",v=[];c("#legend"+r).children("span").each(function(){y+='<input type="checkbox" id="'+r+"CB"+p+'" checked>',y+='<label for="'+r+"CB"+p+'" style="'+c(this).attr("style")+'"> '+c(this).text()+"</label>  ",v.push(r+"CB"+p),p++}),c("#visibility"+r).html(y),v.forEach(function(S){c("#"+S).change(function(){o.setVisibility(parseInt(c(this).attr("id").replace(r+"CB","")),c(this).is(":checked"))})})}function z(r,o){L("onZoom",T(r),T(o))}return(r,o)=>(d(),g("div",{class:"monitoring-chart",ref_key:"chartEl",ref:_},null,512))}},X={id:"charts-container"},Y={class:"row mb-3 mb-2"},ee={class:"col-12 d-flex justify-content-between"},se=e("a",{class:"btn btn-outline-secondary collapse-toggle dropdown-toggle collapsed","data-bs-toggle":"collapse",href:"#metrics",role:"button","aria-expanded":"false","aria-controls":"metrics"},[e("i",{class:"fa fa-area-chart"}),n(`
          Metrics
        `)],-1),te={class:"collapse",id:"metrics"},oe={class:"card card-body bg-light mb-2"},ae={class:"row mb-2"},le={class:"col-4"},ie=e("span",{class:"text-body-secondary text-uppercase"},"System",-1),ne={class:"list-unstyled mb-0"},re={key:0,class:"form-check"},ce=["id","checked","onChange"],de=["for"],ue={class:"col-8"},pe=e("span",{class:"text-body-secondary text-uppercase"},"Postgres",-1),he={class:"columns-2"},ge={class:"list-unstyled mb-0"},me={key:0,class:"form-check"},fe=["id","checked","onChange"],be=["for"],ye={class:"row"},_e={class:"col-8"},ve={class:"list-unstyled list-inline mb-0"},ke={class:"list-inline-item"},we={class:"list-inline-item"},Ce={class:"list-unstyled list-inline mb-0"},Se={class:"list-inline-item"},De=["onClick"],Me=e("div",{class:"col-4 d-flex align-items-end justify-content-end"},[e("button",{class:"btn btn-outline-secondary","data-bs-toggle":"collapse","data-bs-target":"#metrics"},"Close")],-1),ze={class:"card-header"},Le=["href"],Be=e("i",{class:"fa fa-external-link"},null,-1),Fe=[Be],Ae=e("span",{class:"copy"},null,-1),We=["onClick"],xe={class:"card-body"},Ge=["id"],Ke=["id"],Pe=e("div",{class:"row"},[e("div",{class:"col-md-4 col-md-offset-4"},[e("div",{class:"progress"},[e("div",{class:"progress-bar progress-bar-striped",style:{width:"100%"}},"Loading, please wait ...")])])],-1),Te=[Pe],Ne=["id"],Re={__name:"Monitoring",setup(N){const C=E(),u=q(),_=M(null),m=M(null),L=M(null),t={blue:"#5DA5DA",blue2:"#226191",green:"#60BD68",red:"#F15854",gray:"#4D4D4D",light_gray:"#AAAAAA",orange:"#FAA43A"},f=M({Loadavg:{title:"Loadaverage",api:"loadavg",options:{colors:[t.blue,t.orange,t.green],ylabel:"Loadaverage"},category:"system"},CPU:{title:"CPU Usage",api:"cpu",options:{colors:[t.blue,t.green,t.red,t.gray],ylabel:"%",stackedGraph:!0},category:"system"},CtxForks:{title:"Context switches and forks per second",api:"ctxforks",options:{colors:[t.blue,t.green]},category:"system"},Memory:{title:"Memory usage",api:"memory",options:{colors:[t.light_gray,t.green,t.blue,t.orange],ylabel:"Memory",labelsKMB:!1,labelsKMG2:!0,stackedGraph:!0},category:"system"},Swap:{title:"Swap usage",api:"swap",options:{colors:[t.red],ylabel:"Swap",labelsKMB:!1,labelsKMG2:!0,stackedGraph:!0},category:"system"},FsSize:{title:"Filesystems size",api:"fs_size",options:{ylabel:"Size",labelsKMB:!1,labelsKMG2:!0},category:"system"},FsUsage:{title:"Filesystems usage",api:"fs_usage",options:{ylabel:"%"},category:"system"},TPS:{title:"Transactions per second",api:"tps",options:{colors:[t.green,t.red],ylabel:"Transactions",stackedGraph:!0},category:"postgres"},InstanceSize:{title:"Instance size",api:"instance_size",options:{colors:[t.blue],ylabel:"Size",stackedGraph:!0,labelsKMB:!1,labelsKMG2:!0},category:"postgres"},TblspcSize:{title:"Tablespaces size",api:"tblspc_size",options:{ylabel:"Size",stackedGraph:!0,labelsKMB:!1,labelsKMG2:!0},category:"postgres"},Sessions:{title:"Sessions",api:"sessions",options:{ylabel:"Sessions",stackedGraph:!0},category:"postgres"},Blocks:{title:"Blocks Hit vs Read per second",api:"blocks",options:{colors:[t.red,t.green],ylabel:"Blocks"},category:"postgres"},HRR:{title:"Blocks Hit vs Read ratio",api:"hitreadratio",options:{colors:[t.blue],ylabel:"%"},category:"postgres"},Checkpoints:{title:"Checkpoints",api:"checkpoints",options:{ylabel:"Checkpoints",y2label:"Duration",series:{write_time:{axis:"y2"},sync_time:{axis:"y2"}}},category:"postgres"},WalFilesSize:{title:"WAL Files size",api:"wal_files_size",options:{colors:[t.blue,t.blue2],labelsKMB:!1,labelsKMG2:!0,ylabel:"Size"},category:"postgres"},WalFilesCount:{title:"WAL Files",api:"wal_files_count",options:{colors:[t.blue,t.blue2],ylabel:"WAL files"},category:"postgres"},WalFilesRate:{title:"WAL Files written rate",api:"wal_files_rate",options:{colors:[t.blue],ylabel:"Byte per second",labelsKMB:!1,labelsKMG2:!0,stackedGraph:!0},category:"postgres"},WBuffers:{title:"Written buffers",api:"w_buffers",options:{ylabel:"Written buffers",stackedGraph:!0},category:"postgres"},Locks:{title:"Locks",api:"locks",options:{ylabel:"Locks"},category:"postgres"},WLocks:{title:"Waiting Locks",api:"waiting_locks",options:{ylabel:"Waiting Locks"},category:"postgres"}}),B=[{title:"Performance",graphs:["Loadavg","CPU","TPS","Sessions"]},{title:"Locks",graphs:["Locks","WLocks","Sessions"]},{title:"Size",graphs:["FsSize","InstanceSize","TblspcSize","WalFilesSize"]}];var z=C.query.graphs;const r=z?JSON.parse(z):JSON.parse(localStorage.getItem("graphs"))||[].concat(B[0].graphs),o=M(r);function b(s){return o.value.includes(s)}function p(s,a){a.target.checked?o.value.unshift(s):k(s)}function y(){D(Object.keys(f.value))}function v(){D([])}function S(){localStorage.setItem("graphs",JSON.stringify(o.value))}function k(s){o.value.forEach(function(a,i){a==s&&o.value.splice(i,1)})}function D(s){for(;o.value.length;)o.value.pop();s.forEach(a=>{o.value.push(a)})}function w(s,a){L.value.setFromTo(s,a)}R(o.value,()=>{C.query.graphs!==o.value&&u.push({path:C.path,query:j.assign({},C.query,{graphs:JSON.stringify(o.value)})}),S()});function F(s,a){_.value=s,m.value=a}function l(){new $("#metrics").show(),window.scrollTo({top:0})}return(s,a)=>(d(),g("div",X,[e("div",Y,[e("div",ee,[se,n(),U(J,{onFromtoUpdated:F,ref_key:"dateRangePickerEl",ref:L},null,512)])]),n(),e("div",te,[e("div",oe,[e("div",ae,[e("div",le,[ie,n(),e("ul",ne,[(d(!0),g(A,null,W(f.value,(i,h)=>(d(),g("li",null,[i.category=="system"?(d(),g("div",re,[e("input",{type:"checkbox",id:"checkbox"+h,class:"form-check-input",checked:b(h),onChange:G=>p(h,G)},null,40,ce),n(),e("label",{class:"form-check-label",for:"checkbox"+h},x(i.title),9,de)])):P("",!0)]))),256))])]),n(),e("div",ue,[pe,n(),e("div",he,[e("ul",ge,[(d(!0),g(A,null,W(f.value,(i,h)=>(d(),g("li",null,[i.category=="postgres"?(d(),g("div",me,[e("input",{type:"checkbox",id:"checkbox"+h,class:"form-check-input",checked:b(h),onChange:G=>p(h,G)},null,40,fe),n(),e("label",{class:"form-check-label",for:"checkbox"+h},x(i.title),9,be)])):P("",!0)]))),256))])])])]),n(),e("div",ye,[e("div",_e,[e("ul",ve,[e("li",ke,[e("a",{href:"#",onClick:K(y,["prevent"])},"Select all")]),n(),e("li",we,[e("a",{href:"#",onClick:K(v,["prevent"])},"Unselect all")])]),n(),e("ul",Ce,[n(`
              Predefined themes:
              `),(d(),g(A,null,W(B,i=>e("li",Se,[e("a",{href:"#",onClick:K(h=>D(i.graphs),["prevent"])},x(i.title),9,De)])),64))])]),n(),Me])])]),n(),(d(!0),g(A,null,W(o.value,i=>(d(),g("div",{class:"card w-100 mb-2",key:i},[e("div",ze,[n(x(f.value[i].title)+" ",1),e("a",{href:'#/?graphs=["'+i+'"]&start='+_.value+"&end="+m.value,class:"small ms-2",target:"_blank",title:"Link to this graph."},Fe,8,Le),n(),Ae,n(),e("button",{type:"button",class:"btn-close float-end","aria-label":"Close",onClick:h=>k(i)},null,8,We)]),n(),e("div",xe,[e("div",{id:"nodata"+i,class:"nodata-chart text-center d-none alert alert-secondary p-1"},`
          No data available
        `,8,Ge),n(),e("div",{id:"legend"+i,class:"legend-chart"},Te,8,Ke),n(),_.value&&m.value?(d(),V(Q,{key:0,graph:i,id:"chart"+i,metrics:f.value,from:_.value,to:m.value,onOnZoom:w},null,8,["graph","id","metrics","from","to"])):P("",!0),n(),e("div",{id:"visibility"+i,class:"visibility-chart"},null,8,Ne)])]))),128)),n(),e("div",{class:"text-center w-100"},[e("a",{href:"#",onClick:l,class:"btn btn-outline-secondary"}," + More metrics ")])]))}},Oe={template:""},Ue=H({history:I(),routes:[{path:"/:pathMatch(.*)*",name:"not-found",component:Oe}]});Z({components:{monitoring:Re}}).use(Ue).mount("#app");
