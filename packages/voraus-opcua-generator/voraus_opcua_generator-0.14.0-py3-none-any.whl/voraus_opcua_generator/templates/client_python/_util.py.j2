"""An autogenerated module that implements several interfaces utilized in the generated classes."""
from __future__ import annotations
from asyncua.sync import Client as ClientAsyncUA
from asyncua.sync import ThreadLoop
from typing_extensions import Self
from types import TracebackType

class NoRemoteProvidedException(Exception):
    """Is raised while instantiating a ChildOrConnectable implementing object with neither parent nor connection."""

class Client(ClientAsyncUA):
    """A wrapper to cover the underlying OPC UA library in order to provide non-interface-breaking library changes."""

class Connectable:
    """An interface for classes that can possibly invoke an asyncua Client as a context while abstracting it."""
    def __init__(self, uri: str|None):

        self._uri: str|None = uri
        if self._uri is not None:
            tloop = ThreadLoop()
            tloop.daemon = True
            tloop.start()
            self._client: Client = Client(uri, tloop=tloop)

    def __enter__(self) -> Self:
        if self._uri is not None:
            self._client.connect()
        return self

    def __exit__(
        self, exc_type: type[BaseException] | None, exc_val: BaseException | None, exc_tb: TracebackType | None
    ) -> None:
        if self._uri is not None:
            self._client.disconnect()
            self._client.tloop.stop()

class ChildOrConnectable(Connectable):
    """An interface that allows to guarantee an established Connectable and provides an internal method to access it.

    It returns either its own connection, if available, or that of its parent,
    which traverses to the root object, which was instantiated as a connection holding context.
    """
    def __init__(self,  uri: str | None = None, parent: ChildOrConnectable | None = None):
        if parent is None and uri is None:
            raise NoRemoteProvidedException

        self._parent: ChildOrConnectable | None = parent
        Connectable.__init__(self, uri)

    @property
    def established_connection(self) -> Client:
        """Provide an established connection to an OPC UA server.

        Returns:
             A generic OPC UA client to work on.
        """
        if self._parent is not None:
            return self._parent.established_connection
        return self._client
